à
ZC:\Users\akaxb\source\repos\MicroServices\User.Identity\Authentication\SmsCodeValidator.cs
	namespace		 	
User		
 
.		 
Identity		 
.		 
Authentication		 &
{

 
public 

class 
SmsCodeValidator !
:" #$
IExtensionGrantValidator$ <
{ 
public 
string 
	GrantType 
=>  "
$str# 2
;2 3
private 
readonly 
IAuthCodeService )
_authCodeService* :
;: ;
private 
readonly 
IUserService %
_userService& 2
;2 3
public 
SmsCodeValidator 
(  
IAuthCodeService  0
authCodeService1 @
,@ A
IUserServiceB N
userServiceO Z
)Z [
{ 	
_authCodeService 
= 
authCodeService .
;. /
_userService 
= 
userService &
;& '
} 	
public 
async 
Task 
ValidateAsync '
(' (+
ExtensionGrantValidationContext( G
contextH O
)O P
{ 	
var 
phone 
= 
context 
.  
Request  '
.' (
Raw( +
[+ ,
$str, 3
]3 4
;4 5
var 
code 
= 
context 
. 
Request &
.& '
Raw' *
[* +
$str+ 6
]6 7
;7 8
if 
( 
string 
. 
IsNullOrEmpty $
($ %
phone% *
)* +
||, .
string/ 5
.5 6
IsNullOrEmpty6 C
(C D
codeD H
)H I
)I J
{ 
context 
. 
Result 
=  
new! $!
GrantValidationResult% :
(: ;
TokenRequestErrors; M
.M N
InvalidGrantN Z
,Z [
$str\ i
)i j
;j k
return   
;   
}!! 
if"" 
("" 
!"" 
_authCodeService"" !
.""! "
Validate""" *
(""* +
phone""+ 0
,""0 1
code""2 6
)""6 7
)""7 8
{## 
context$$ 
.$$ 
Result$$ 
=$$  
new$$! $!
GrantValidationResult$$% :
($$: ;
TokenRequestErrors$$; M
.$$M N
InvalidGrant$$N Z
,$$Z [
$str$$\ d
)$$d e
;$$e f
return%% 
;%% 
}&& 
int'' 
id'' 
='' 
await'' 
_userService'' '
.''' (
CreateOrCheckAsync''( :
('': ;
phone''; @
)''@ A
;''A B
if(( 
((( 
id(( 
<=(( 
$num(( 
)(( 
{)) 
context** 
.** 
Result** 
=**  
new**! $!
GrantValidationResult**% :
(**: ;
TokenRequestErrors**; M
.**M N
InvalidGrant**N Z
,**Z [
$str**\ h
)**h i
;**i j
return++ 
;++ 
},, 
context-- 
.-- 
Result-- 
=-- 
new--  !
GrantValidationResult--! 6
(--6 7
id--7 9
.--9 :
ToString--: B
(--B C
)--C D
,--D E
	GrantType--E N
)--N O
;--O P
}.. 	
}// 
}00 Ä
AC:\Users\akaxb\source\repos\MicroServices\User.Identity\Config.cs
	namespace 	
User
 
. 
Identity 
{		 
public

 

class

 
Config

 
{ 
public 
static 
IEnumerable !
<! "
ApiResource" -
>- .
GetApiResources/ >
(> ?
)? @
{ 	
return 
new 
List 
< 
ApiResource '
>' (
{) *
new 
ApiResource 
(  
$str  -
,- .
$str. ;
); <
} 
; 
} 	
public 
static 
IEnumerable !
<! "
Client" (
>( )

GetClients* 4
(4 5
)5 6
{ 	
return 
new 
List 
< 
Client "
>" #
{$ %
new 
Client 
{ 
ClientId 
= 
$str *
,* +
ClientSecrets !
=! "
new" %
List& *
<* +
Secret+ 1
>1 2
{ 
new 
Secret "
(" #
$str# -
.- .
Sha256. 4
(4 5
)5 6
)6 7
} 
, "
RefreshTokenExpiration *
=* +
TokenExpiration+ :
.: ;
Sliding; B
,B C
AllowOfflineAccess &
=& '
true' +
,+ ,
RequireClientSecret '
=' (
false( -
,- .
AllowedGrantTypes %
=% &
new& )
List* .
<. /
string/ 5
>5 6
{6 7
$str7 F
}F G
,G H,
 AlwaysIncludeUserClaimsInIdToken   4
=  4 5
true  5 9
,  9 :
AllowedScopes!! !
=!!! "
new!!" %
List!!& *
<!!* +
string!!+ 1
>!!1 2
{!!2 3
$str"" %
,""% &#
IdentityServerConstants## /
.##/ 0
StandardScopes##0 >
.##> ?
OfflineAccess##? L
,##L M#
IdentityServerConstants$$ /
.$$/ 0
StandardScopes$$0 >
.$$> ?
Profile$$? F
,$$F G#
IdentityServerConstants%% /
.%%/ 0
StandardScopes%%0 >
.%%> ?
OpenId%%? E
}&& 
}'' 
}(( 
;(( 
})) 	
public++ 
static++ 
IEnumerable++ !
<++! "
IdentityResource++" 2
>++2 3 
GetIdentityResources++4 H
(++H I
)++I J
{,, 	
return-- 
new-- 
List-- 
<-- 
IdentityResource-- ,
>--, -
{--. /
new.. 
IdentityResources.. %
...% &
Profile..& -
(..- .
)... /
,../ 0
new// 
IdentityResources// %
.//% &
OpenId//& ,
(//, -
)//- .
}00 
;00 
}11 	
}22 
}33 ˜
WC:\Users\akaxb\source\repos\MicroServices\User.Identity\Controllers\ValuesController.cs
	namespace 	
User
 
. 
Identity 
. 
Controllers #
{ 
[		 
Route		 

(		
 
$str		 
)		 
]		 
public

 

class

 
ValuesController

 !
:

" #

Controller

$ .
{ 
[ 	
HttpGet	 
] 
public 
IEnumerable 
< 
string !
>! "
Get# &
(& '
)' (
{ 	
return 
new 
string 
[ 
] 
{  !
$str" *
,* +
$str, 4
}5 6
;6 7
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
public 
string 
Get 
( 
int 
id  
)  !
{ 	
return 
$str 
; 
} 	
[ 	
HttpPost	 
] 
public 
void 
Post 
( 
[ 
FromBody "
]" #
string# )
value* /
)/ 0
{ 	
} 	
[!! 	
HttpPut!!	 
(!! 
$str!! 
)!! 
]!! 
public"" 
void"" 
Put"" 
("" 
int"" 
id"" 
,"" 
[""  !
FromBody""! )
]"") *
string""* 0
value""1 6
)""6 7
{## 	
}$$ 	
['' 	

HttpDelete''	 
('' 
$str'' 
)'' 
]'' 
public(( 
void(( 
Delete(( 
((( 
int(( 
id(( !
)((! "
{)) 	
}** 	
}++ 
},, ˘
LC:\Users\akaxb\source\repos\MicroServices\User.Identity\Dto\ConsulOptions.cs
	namespace 	
User
 
. 
Identity 
. 
Dtos 
{ 
public 

class 
ConsulOptions 
{		 
public

 
string

 
HttpEndpoint

 "
{

# $
get

% (
;

( )
set

* -
;

- .
}

/ 0
public 
DnsEndpoint 
DnsEndpoint &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
} 
} ⁄
JC:\Users\akaxb\source\repos\MicroServices\User.Identity\Dto\DnsEndpoint.cs
	namespace 	
User
 
. 
Identity 
. 
Dtos 
{ 
public		 

class		 
DnsEndpoint		 
{

 
public 
string 
Address 
{ 
get  #
;# $
set% (
;( )
}* +
public 
int 
Port 
{ 
get 
; 
set "
;" #
}$ %
public 

IPEndPoint 
ToIPEndPoint &
(& '
)' (
{ 	
return 
new 

IPEndPoint !
(! "
	IPAddress" +
.+ ,
Parse, 1
(1 2
Address2 9
)9 :
,: ;
Port< @
)@ A
;A B
} 	
} 
} â
VC:\Users\akaxb\source\repos\MicroServices\User.Identity\Dto\ServiceDiscoveryOptions.cs
	namespace 	
User
 
. 
Identity 
. 
Dtos 
{ 
public 

class #
ServiceDiscoveryOptions (
{		 
public

 
string

 
ServiceName

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
public 
ConsulOptions 
Consul #
{$ %
get& )
;) *
set+ .
;. /
}0 1
} 
} µ&
aC:\Users\akaxb\source\repos\MicroServices\User.Identity\Infrastructure\ResilienceClientFactory.cs
	namespace 	
User
 
. 
Identity 
. 
Infrastructure &
{ 
public 

class #
ResilienceClientFactory (
{ 
private 
ILogger 
<  
ResilienceHttpClient ,
>, -
_logger. 5
;5 6
private  
IHttpContextAccessor $ 
_httpContextAccessor% 9
;9 :
private 
int 
_retryCount 
;  
private 
int 0
$_exceptionCountAllowedBeforeBreaking 8
;8 9
public #
ResilienceClientFactory &
(& '
ILogger' .
<. / 
ResilienceHttpClient/ C
>C D
loggerE K
,K L 
IHttpContextAccessorM a
httpContextAccessorb u
,u v
intw z

retryCount	{ Ö
,
Ö Ü
int
á ä1
#exceptionCountAllowedBeforeBreaking
ã Æ
)
Æ Ø
{ 	
_logger 
= 
logger 
;  
_httpContextAccessor  
=! "
httpContextAccessor# 6
;6 7
_retryCount   
=   

retryCount   $
;  $ %0
$_exceptionCountAllowedBeforeBreaking!! 0
=!!1 2/
#exceptionCountAllowedBeforeBreaking!!3 V
;!!V W
}"" 	
public$$  
ResilienceHttpClient$$ ##
GetResilienceHttpClient$$$ ;
($$; <
)$$< =
=>$$> @
new%%  
ResilienceHttpClient%% 
(%% 
(%% 
origin%%  
)%%  !
=>%%" $
CreatePolicies%%% 3
(%%3 4
origin%%4 :
)%%: ;
,%%; <
_logger%%= D
,%%D E 
_httpContextAccessor%%F Z
)%%Z [
;%%[ \
private'' 
Policy'' 
['' 
]'' 
CreatePolicies'' '
(''' (
string''( .
origin''/ 5
)''5 6
{(( 	
return)) 
new)) 
Policy)) 
[)) 
])) 
{))  !
Policy** 
.** 
Handle** 
<**  
HttpRequestException** 2
>**2 3
(**3 4
)**4 5
.++ 
WaitAndRetryAsync++ "
(++" #
_retryCount++# .
,++. /
retryAttempt++/ ;
=>++; =
TimeSpan++= E
.++E F
FromSeconds++F Q
(++Q R
Math++R V
.++V W
Pow++W Z
(++Z [
$num++[ \
,++\ ]
retryAttempt++] i
)++i j
)++j k
,,, 
(,, 
	exception,, 
,,, 
timeSpan,, $
,,,$ %

retryCount,,% /
,,,/ 0
context,,0 7
),,7 8
=>,,8 :
{,,: ;
var-- 
msg-- 
=-- 
$"-- 
Á¨¨-- 
{--  

retryCount--  *
}--* +
	Ê¨°ÈáçËØï--+ .
"--. /
+.. 
$".. 
of .. 
{.. 
context.. "
..." #
	PolicyKey..# ,
}.., -
"..- .
+// 
$"// 
at // 
{// 
context// "
.//" #
ExecutionKey//# /
}/// 0
"//0 1
+00 
$"00 
due to 00 
{00 
	exception00 (
}00( )
"00) *
;00* +
_logger11 
.11 

LogWarning11 &
(11& '
msg11' *
)11* +
;11+ ,
_logger22 
.22 
LogDebug22 $
(22$ %
msg22% (
)22( )
;22) *
}33 
)44 
,44 
Policy55 
.55 
Handle55 
<55  
HttpRequestException55 2
>552 3
(553 4
)554 5
.555 6
CircuitBreakerAsync556 I
(55I J0
$_exceptionCountAllowedBeforeBreaking55J n
,55n o
TimeSpan66 
.66 
FromMinutes66 $
(66$ %
$num66% &
)66& '
,66' (
(77 
	exception77 
,77 
duration77 #
)77# $
=>77$ &
{77& '
_logger88 
.88 
LogTrace88 $
(88$ %
$str88% +
)88+ ,
;88, -
}99 
,99 
(99 
)99 
=>99 
{99 
_logger:: 
.:: 
LogTrace:: $
(::$ %
$str::% +
)::+ ,
;::, -
};; 
);; 
}<< 
;<< 
}== 	
}>> 
}?? ¬	
BC:\Users\akaxb\source\repos\MicroServices\User.Identity\Program.cs
	namespace 	
User
 
. 
Identity 
{ 
public 

class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{ 	
BuildWebHost 
( 
args 
) 
. 
Run "
(" #
)# $
;$ %
} 	
public 
static 
IWebHost 
BuildWebHost +
(+ ,
string, 2
[2 3
]3 4
args5 9
)9 :
=>; =
WebHost 
.  
CreateDefaultBuilder (
(( )
args) -
)- .
. 

UseStartup 
< 
Startup #
># $
($ %
)% &
. 
UseUrls 
( 
$str 0
)0 1
. 
Build 
( 
) 
; 
} 
} ¯
SC:\Users\akaxb\source\repos\MicroServices\User.Identity\Services\AuthCodeService.cs
	namespace 	
User
 
. 
Identity 
. 
Services  
{ 
public 

class 
AuthCodeService  
:! "
IAuthCodeService# 3
{		 
public

 
bool

 
Validate

 
(

 
string

 #
phone

$ )
,

) *
string

+ 1
code

2 6
)

6 7
{ 	
return 
true 
; 
} 	
} 
} ˘
TC:\Users\akaxb\source\repos\MicroServices\User.Identity\Services\IAuthCodeService.cs
	namespace 	
User
 
. 
Identity 
. 
Services  
{ 
public 

	interface 
IAuthCodeService %
{		 
bool

 
Validate

 
(

 
string

 
phone

 "
,

" #
string

# )
code

* .
)

. /
;

/ 0
} 
} ı
PC:\Users\akaxb\source\repos\MicroServices\User.Identity\Services\IUserService.cs
	namespace 	
User
 
. 
Identity 
. 
Services  
{ 
public 

	interface 
IUserService !
{		 
Task

 
<

 
int

 
>

 
CreateOrCheckAsync

 $
(

$ %
string

% +
phone

, 1
)

1 2
;

2 3
} 
} ¢%
OC:\Users\akaxb\source\repos\MicroServices\User.Identity\Services\UserService.cs
	namespace 	
User
 
. 
Identity 
. 
Services  
{ 
public 

class 
UserService 
: 
IUserService +
{ 
private 
string 
url 
; 
private 
readonly 
IHttpClient $
_httpClient% 0
;0 1
private 
readonly 
ILogger  
<  !
UserService! ,
>, -
_logger. 5
;5 6
public 
UserService 
( 
IHttpClient &

httpClient' 1
,1 2
	IDnsQuery 
dnsQuery 
, 
IOptions 
< #
ServiceDiscoveryOptions ,
>, -
options. 5
,5 6
ILogger 
< 
UserService 
>  
logger! '
)' (
{ 	
_httpClient 
= 

httpClient $
;$ %
var 
address 
= 
dnsQuery "
." #
ResolveService# 1
(1 2
$str2 B
,B C
optionsD K
.K L
ValueL Q
.Q R
ServiceNameR ]
)] ^
;^ _
var 
addressList 
= 
address %
.% &
First& +
(+ ,
), -
.- .
AddressList. 9
;9 :
var 
host 
= 
addressList "
." #
Any# &
(& '
)' (
?) *
addressList+ 6
.6 7
First7 <
(< =
)= >
.> ?
ToString? G
(G H
)H I
:J K
addressL S
.S T
FirstT Y
(Y Z
)Z [
.[ \
HostName\ d
;d e
var   
port   
=   
address   
.   
First   $
(  $ %
)  % &
.  & '
Port  ' +
;  + ,
url!! 
=!! 
$"!! 
http://!! 
{!! 
host!!  
}!!  !
:!!! "
{!!" #
port!!# '
}!!' (
"!!( )
;!!) *
_logger"" 
="" 
logger"" 
;"" 
}## 	
public%% 
async%% 
Task%% 
<%% 
int%% 
>%% 
CreateOrCheckAsync%% 1
(%%1 2
string%%2 8
phone%%9 >
)%%> ?
{&& 	
var'' 
form'' 
='' 
new'' 

Dictionary'' %
<''% &
string''& ,
,'', -
string''. 4
>''4 5
{''6 7
{(( 
$str(( 
,(( 
phone(( 
}((  
}((! "
;((" #
try)) 
{** 
var++ 
response++ 
=++ 
await++ $
_httpClient++% 0
.++0 1
	PostAsync++1 :
(++: ;
$"++; =
{++= >
url++> A
}++A B(
/api/appuser/check-or-create++B ^
"++^ _
,++_ `
form++a e
)++e f
;++f g
if,, 
(,, 
response,, 
.,, 

StatusCode,, '
==,,( *
System,,+ 1
.,,1 2
Net,,2 5
.,,5 6
HttpStatusCode,,6 D
.,,D E
OK,,E G
),,G H
{-- 
var.. 
userId.. 
=..  
await..! &
response..' /
.../ 0
Content..0 7
...7 8
ReadAsStringAsync..8 I
(..I J
)..J K
;..K L
int// 
.// 
TryParse//  
(//  !
userId//! '
,//' (
out//) ,
int//- 0
id//1 3
)//3 4
;//4 5
return00 
id00 
;00 
}11 
}22 
catch33 
(33 
	Exception33 
ex33 
)33  
{44 
_logger55 
.55 
LogError55  
(55  !
$"55! #.
"CreateOrCheckAsyncÈáçËØïÂ§±Ë¥•--- 55# =
{55= >
ex55> @
.55@ A
Message55A H
}55H I
"55I J
)55J K
;55K L
throw66 
ex66 
;66 
}77 
return88 
$num88 
;88 
}99 	
}:: 
};; ˇ)
BC:\Users\akaxb\source\repos\MicroServices\User.Identity\Startup.cs
	namespace 	
User
 
. 
Identity 
{ 
public 

class 
Startup 
{ 
public 
Startup 
( 
IConfiguration %
configuration& 3
)3 4
{ 	
Configuration 
= 
configuration )
;) *
} 	
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
public   
void   
ConfigureServices   %
(  % &
IServiceCollection  & 8
services  9 A
)  A B
{!! 	
services"" 
."" 
AddMvc"" 
("" 
)"" 
;"" 
services## 
.## 
AddIdentityServer## &
(##& '
)##' (
.$$ &
AddExtensionGrantValidator$$ /
<$$/ 0
Authentication$$0 >
.$$> ?
SmsCodeValidator$$? O
>$$O P
($$P Q
)$$Q R
.%% )
AddDeveloperSigningCredential%% 2
(%%2 3
)%%3 4
.&& 
AddInMemoryClients&& '
(&&' (
Config&&( .
.&&. /

GetClients&&/ 9
(&&9 :
)&&: ;
)&&; <
.'' (
AddInMemoryIdentityResources'' 1
(''1 2
Config''2 8
.''8 9 
GetIdentityResources''9 M
(''M N
)''N O
)''O P
.(( #
AddInMemoryApiResources(( ,
(((, -
Config((- 3
.((3 4
GetApiResources((4 C
(((C D
)((D E
)((E F
;((F G
services)) 
.)) 
	AddScoped)) 
<)) 
IAuthCodeService)) /
,))/ 0
AuthCodeService))1 @
>))@ A
())A B
)))B C
;))C D
services** 
.** 
	AddScoped** 
<** 
IUserService** +
,**+ ,
UserService**- 8
>**8 9
(**9 :
)**: ;
;**; <
services-- 
.-- 
AddSingleton-- !
(--! "
typeof--" (
(--( )#
ResilienceClientFactory--) @
)--@ A
,--A B
(--C D
sp--D F
)--F G
=>--H J
{.. 
var// 
logger// 
=// 
sp//  
.//  !
GetRequiredService//! 3
<//3 4
ILogger//4 ;
<//; < 
ResilienceHttpClient//< P
>//P Q
>//Q R
(//R S
)//S T
;//T U
var00 
httpContextAccessor00 (
=00) *
sp00+ -
.00- .

GetService00. 8
<008 9 
IHttpContextAccessor009 M
>00M N
(00N O
)00O P
;00P Q
return11 
new11 #
ResilienceClientFactory11 3
(113 4
logger114 :
,11: ;
httpContextAccessor11< O
,11O P
$num11Q R
,11R S
$num11T U
)11U V
;11V W
}22 
)22 
;22 
services44 
.44 
AddSingleton44 !
<44! "
IHttpClient44" -
>44- .
(44. /
sp44/ 1
=>442 4
{55 
var66 
factory66 
=66 
sp66  
.66  !
GetRequiredService66! 3
<663 4#
ResilienceClientFactory664 K
>66K L
(66L M
)66M N
;66N O
return77 
factory77 
.77 #
GetResilienceHttpClient77 6
(776 7
)777 8
;778 9
}88 
)88 
;88 
services99 
.99 
	Configure99 
<99 #
ServiceDiscoveryOptions99 6
>996 7
(997 8
Configuration998 E
.99E F

GetSection99F P
(99P Q
$str99Q c
)99c d
)99d e
;99e f
services:: 
.:: 
AddSingleton:: !
<::! "
	IDnsQuery::" +
>::+ ,
(::, -
p::- .
=>::/ 1
{;; 
return<< 
new<< 
LookupClient<< '
(<<' (
	IPAddress<<( 1
.<<1 2
Parse<<2 7
(<<7 8
$str<<8 C
)<<C D
,<<D E
$num<<F J
)<<J K
;<<K L
}== 
)== 
;== 
}>> 	
publicAA 
voidAA 
	ConfigureAA 
(AA 
IApplicationBuilderAA 1
appAA2 5
,AA5 6
IHostingEnvironmentAA7 J
envAAK N
)AAN O
{BB 	
ifCC 
(CC 
envCC 
.CC 
IsDevelopmentCC !
(CC! "
)CC" #
)CC# $
{DD 
appEE 
.EE %
UseDeveloperExceptionPageEE -
(EE- .
)EE. /
;EE/ 0
}FF 
appGG 
.GG 
UseIdentityServerGG !
(GG! "
)GG" #
;GG# $
appHH 
.HH 
UseMvcHH 
(HH 
)HH 
;HH 
}II 	
}JJ 
}KK 